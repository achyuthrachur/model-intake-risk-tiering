generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model UseCase {
  id                      String       @id @default(uuid())
  title                   String
  businessLine            String
  description             String
  aiType                  String       // Model Type: Traditional ML / GenAI / Rules / Hybrid
  usageType               String       // Decisioning / Advisory / Automation
  humanInLoop             String       // Required / Optional / None
  customerImpact          String       // Direct / Indirect / None
  regulatoryDomains       String       // JSON array stored as string
  deployment              String       // Internal tool / Customer-facing / 3rd-party
  vendorInvolved          Boolean      @default(false)
  vendorName              String?
  intendedUsers           String?
  downstreamDecisions     String?

  // Data Profile
  containsPii             Boolean      @default(false)
  containsNpi             Boolean      @default(false)
  sensitiveAttributesUsed Boolean      @default(false)
  trainingDataSource      String?      // Internal / Vendor / Public / Unknown / N/A
  retentionPolicyDefined  Boolean      @default(false)
  loggingRequired         Boolean      @default(false)
  accessControlsDefined   Boolean      @default(false)

  // Model Profile
  modelDefinitionTrigger  Boolean      @default(false)
  explainabilityRequired  Boolean      @default(false)
  changeFrequency         String?      // Ad hoc / Quarterly / Monthly / Continuous
  retraining              Boolean      @default(false)
  overridesAllowed        Boolean      @default(false)
  fallbackPlanDefined     Boolean      @default(false)

  // Controls & Monitoring
  monitoringCadence       String?      // Daily / Weekly / Monthly / Quarterly / None
  humanReviewProcess      String?
  incidentResponseContact String?

  // Status & Metadata
  status                  String       @default("Draft") // Draft / Submitted / Under Review / Approved / Rejected / Sent Back
  createdBy               String       @default("demo-user")
  createdAt               DateTime     @default(now())
  updatedAt               DateTime     @updatedAt

  // Review fields (for MRM workflow)
  reviewerNotes           String?      // Notes from MRM when sent back
  reviewedBy              String?      // MRM who reviewed
  reviewedAt              DateTime?    // When reviewed

  // Relations
  decision                Decision?
  attachments             Attachment[]
  auditEvents             AuditEvent[]
  inventoryModel          InventoryModel?
}

model Decision {
  id                 String   @id @default(uuid())
  useCaseId          String   @unique
  useCase            UseCase  @relation(fields: [useCaseId], references: [id], onDelete: Cascade)
  isModel            String   // Yes / No / Model-like
  tier               String   // T1 / T2 / T3
  triggeredRules     String   // JSON array stored as string
  rationaleSummary   String
  requiredArtifacts  String   // JSON array stored as string
  missingEvidence    String   // JSON array stored as string
  riskFlags          String   // JSON array stored as string
  generatedDocuments String?  // JSON array of paths
  aiInsights         String?  // JSON: AI-generated risk assessment insights
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
}

model Attachment {
  id          String   @id @default(uuid())
  useCaseId   String
  useCase     UseCase  @relation(fields: [useCaseId], references: [id], onDelete: Cascade)
  filename    String
  type        String   // Business one-pager / Architecture diagram / Vendor doc / Data dictionary
  artifactId  String?  // Links to artifact from config (e.g., "ValidationPlan", "ModelCard")
  storagePath String
  fileSize    Int?
  mimeType    String?
  createdAt   DateTime @default(now())
}

model AuditEvent {
  id          String   @id @default(uuid())
  useCaseId   String
  useCase     UseCase  @relation(fields: [useCaseId], references: [id], onDelete: Cascade)
  actor       String
  eventType   String   // Created / Updated / Submitted / DecisionGenerated / Exported / AttachmentUploaded
  details     String?  // JSON details
  diffSummary String?
  timestamp   DateTime @default(now())
}

// =============================================
// MODEL INVENTORY MANAGEMENT
// =============================================

model InventoryModel {
  id                        String       @id @default(uuid())
  useCaseId                 String       @unique
  useCase                   UseCase      @relation(fields: [useCaseId], references: [id], onDelete: Cascade)

  inventoryNumber           String       @unique  // e.g., "MDL-2024-001"
  addedToInventoryAt        DateTime     @default(now())
  addedBy                   String

  // Classification (copied from Decision at approval time)
  tier                      String       // T1 / T2 / T3
  validationFrequencyMonths Int          // 12=T3, 24=T2, 36=T1

  // Production tracking
  productionDate            DateTime?
  validatedBeforeProduction Boolean      @default(false)
  lastValidationDate        DateTime?
  nextValidationDue         DateTime

  // Status
  status                    String       @default("Active") // Active / Retired / Suspended

  createdAt                 DateTime     @default(now())
  updatedAt                 DateTime     @updatedAt

  validations               Validation[]
}

model Validation {
  id                 String              @id @default(uuid())
  inventoryModelId   String
  inventoryModel     InventoryModel      @relation(fields: [inventoryModelId], references: [id], onDelete: Cascade)

  validationType     String              // Initial / Periodic / Triggered
  validationDate     DateTime
  validatedBy        String
  status             String              @default("Completed") // In Progress / Completed / Cancelled
  overallResult      String?             // Satisfactory / Satisfactory with Findings / Unsatisfactory
  summaryNotes       String?

  // Report artifact
  reportFilename     String?
  reportStoragePath  String?

  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt

  findings           ValidationFinding[]
}

model ValidationFinding {
  id                 String     @id @default(uuid())
  validationId       String
  validation         Validation @relation(fields: [validationId], references: [id], onDelete: Cascade)

  findingNumber      String     // F-001, F-002
  title              String
  description        String
  severity           String     // Critical / High / Medium / Low
  category           String?    // Performance / Documentation / Controls / Data Quality

  // Remediation
  remediationStatus  String     @default("Open") // Open / In Progress / Remediated / Accepted
  remediationNotes   String?
  remediationDueDate DateTime?
  remediatedAt       DateTime?
  remediatedBy       String?

  // MRM Sign-off
  mrmSignedOff       Boolean    @default(false)
  mrmSignOffDate     DateTime?
  mrmSignOffBy       String?
  mrmSignOffNotes    String?

  createdAt          DateTime   @default(now())
  updatedAt          DateTime   @updatedAt
}
